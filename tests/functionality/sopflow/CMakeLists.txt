#[[ Functionality tests for ExaGO SOPFLOW applications ]]

set_source_files_properties(
  sopflow.c sopflowselfcheck.c PROPERTIES LANGUAGE CXX
)

add_executable(testSopflowFunctionality sopflow.c sopflowselfcheck.c)
target_include_directories(
  testSopflowFunctionality PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}
)

set(tolerance "1e-3")

#[[ Configure SOPFLOW functionality tests ]]
target_link_libraries(testSopflowFunctionality ExaGO::SOPFLOW)
if(EXAGO_INSTALL_TESTS)
  install(TARGETS testSopflowFunctionality
          RUNTIME DESTINATION tests/functionality
  )

  foreach(ns RANGE 1 3)
    exago_add_test(
      NAME
      SOPFLOW_200bus_IPOPT_${ns}scen
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      IPOPT
      -sopflow_enable_multicontingency
      0
      -sopflow_Ns
      ${ns}
      DEPENDS
      IPOPT
    )
    exago_add_test(
      NAME
      SOPFLOW_200bus_EMPAR_${ns}scen
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      EMPAR
      -sopflow_enable_multicontingency
      0
      -sopflow_Ns
      ${ns}
      DEPENDS
      IPOPT
    )
  endforeach()

  # Multicontingency
  exago_add_test(
    NAME
    SOPFLOW_9bus_3scen_9cont
    COMMAND
    ${RUNCMD}
    $<TARGET_FILE:app_sopflow>
    -netfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
    -scenfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
    -ctgcfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9.cont
    -sopflow_solver
    IPOPT
    -sopflow_enable_multicontingency
    1
    -sopflow_Ns
    -1
    -scopflow_Nc
    -1
    DEPENDS
    IPOPT
  )

  # Multicontingency-multiperiod
  exago_add_test(
    NAME
    SOPFLOW_9bus_3scen_9cont_3steps
    COMMAND
    ${RUNCMD}
    $<TARGET_FILE:app_sopflow>
    -netfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
    -scenfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
    -ctgcfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9.cont
    -scopflow_ploadprofile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/load_P.csv
    -scopflow_qloadprofile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/load_Q.csv
    -sopflow_solver
    IPOPT
    -sopflow_enable_multicontingency
    1
    -scopflow_enable_multiperiod
    1
    -scopflow_dT
    5.0
    -scopflow_duration
    0.16666667
    -sopflow_Ns
    -1
    -scopflow_Nc
    -1
    DEPENDS
    IPOPT
  )

  message(STATUS "Configuring SOPFLOW functionality tests")
  foreach(ns RANGE 1 3)
    exago_add_test(
      NAME
      FUNCTIONALITY_TEST_SOPFLOW_200bus_IPOPT_${ns}scen
      DEPENDS
      IPOPT
      NETFILES
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:testSopflowFunctionality>
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      IPOPT
      -sopflow_enable_multicontingency
      0
      -sopflow_Ns
      ${ns}
      -sopflow_tolerance
      ${tolerance}
      -opflow_initialization
      ACPF
      -opflow_genbusvoltage
      VARIABLE_WITHIN_BOUNDS
    )
  endforeach(ns)

  exago_add_test(
    NAME
    FUNCTIONALITY_TEST_SOPFLOW_9bus_3scen_9cont
    COMMAND
    ${RUNCMD}
    $<TARGET_FILE:testSopflowFunctionality>
    -netfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
    -scenfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
    -ctgcfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9.cont
    -sopflow_solver
    IPOPT
    -sopflow_enable_multicontingency
    1
    -sopflow_tolerance
    ${tolerance}
    -sopflow_Ns
    -1
    -scopflow_Nc
    -1
    -opflow_initialization
    ACPF
    -opflow_genbusvoltage
    VARIABLE_WITHIN_BOUNDS
    DEPENDS
    IPOPT
  )

  exago_add_test(
    NAME
    FUNCTIONALITY_TEST_SOPFLOW_9bus_3scen_9cont_3steps
    COMMAND
    ${RUNCMD}
    $<TARGET_FILE:testSopflowFunctionality>
    -netfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
    -scenfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
    -ctgcfile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/case9.cont
    -scopflow_ploadprofile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/load_P.csv
    -scopflow_qloadprofile
    ${CMAKE_SOURCE_DIR}/datafiles/case9/load_Q.csv
    -sopflow_solver
    IPOPT
    -sopflow_enable_multicontingency
    1
    -sopflow_tolerance
    ${tolerance}
    -scopflow_enable_multiperiod
    1
    -scopflow_dT
    5.0
    -scopflow_duration
    0.16666667
    -sopflow_Ns
    -1
    -scopflow_Nc
    -1
    -opflow_initialization
    ACPF
    -opflow_genbusvoltage
    VARIABLE_WITHIN_BOUNDS
    DEPENDS
    IPOPT
  )

    # Tests for HIOP pridecomp
  if(EXAGO_ENABLE_HIOP_DISTRIBUTED)
    exago_add_test(
      NAME
      SOPFLOW_9bus_HIOP_SERIAL
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -opflow_initialization
      ACPF
      -sopflow_subproblem_solver
      HIOP
      -sopflow_subproblem_model
      POWER_BALANCE_HIOP
      -hiop_compute_mode
      CPU
      -hiop_verbosity_level
      3
      DEPENDS
      IPOPT
      HIOP
    )

    exago_add_test(
      NAME
      SOPFLOW_200bus_HIOP_SERIAL
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -opflow_initialization
      ACPF
      -sopflow_subproblem_solver
      HIOP
      -sopflow_subproblem_model
      POWER_BALANCE_HIOP
      -hiop_compute_mode
      CPU
      -hiop_verbosity_level
      3
      DEPENDS
      IPOPT
      HIOP
    )

    exago_add_test(
      NAME
      SOPFLOW_200bus_HIOP_MPI
      COMMAND
      ${MPICMD}
      "-n"
      3
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -sopflow_subproblem_solver
      HIOP
      -sopflow_subproblem_model
      POWER_BALANCE_HIOP
      -hiop_compute_mode
      CPU
      -hiop_verbosity_level
      3
      -opflow_initialization
      ACPF
      DEPENDS
      IPOPT
      HIOP
    )

    # These GPU tests will fail because of the bad_cast bug in HIOP
    exago_add_test(
      NAME
      SOPFLOW_9bus_HIOP_SERIAL_GPU
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case9/case9mod_gen3_wind.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/case9/scenarios_9bus.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -opflow_initialization
      ACPF
      -sopflow_subproblem_solver
      HIOP
      -sopflow_subproblem_model
      PBPOLRAJAHIOP
      -hiop_compute_mode
      GPU
      -hiop_verbosity_level
      3
      DEPENDS
      IPOPT
      HIOP
    )

    exago_add_test(
      NAME
      SOPFLOW_200bus_HIOP_SERIAL_GPU
      COMMAND
      ${RUNCMD}
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/scenarios_200bus.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -opflow_initialization
      ACPF
      -sopflow_subproblem_solver
      HIOP
      -sopflow_subproblem_model
      PBPOLRAJAHIOP
      -hiop_compute_mode
      CPU
      -hiop_verbosity_level
      3
      DEPENDS
      IPOPT
      HIOP
    )

    exago_add_test(
      NAME
      SOPFLOW_200bus_HIOP_MPI_GPU
      COMMAND
      ${MPICMD}
      "-n"
      3
      $<TARGET_FILE:app_sopflow>
      -netfile
      ${CMAKE_SOURCE_DIR}/datafiles/case_ACTIVSg200.m
      -scenfile
      ${CMAKE_SOURCE_DIR}/datafiles/TAMU200_scenarios/case_ACTIVSg200.csv
      -sopflow_solver
      HIOP
      -sopflow_Ns
      -1
      -opflow_initialization
      ACPF
      -sopflow_subproblem_solver 
      HIOP
      -sopflow_subproblem_model
      PBPOLRAJAHIOP
      -hiop_compute_mode
      GPU
      -hiop_verbosity_level
      3
      DEPENDS
      IPOPT
      HIOP
    )
  endif()
endif()
