\chapter{Optimal power flow (OPFLOW)}\label{chap:opflow}

OPFLOW solves the full AC optimal power flow problem and provides various flexible features that can be toggled via run-time options. It has interfaces to different optimization solvers that can be executed on CPUs or on GPUs.

\section{Formulation}
Optimal power flow is a general nonlinear programming problem with the following form
\begin{align}
\text{min. }& f(x) \\
&\text{s.t.} \nonumber \\
& g(x) = 0 \\
& h(x) \le 0 \\
& x^{\text{min}} \le x \le x^{\text{max}}
\end{align}
Here, $x$ are the decision variables with lower and upper bounds $x^{\text{min}}$ and $x^{\text{max}}$, respectively, $f(x)$ is the objective function, $g(x)$ and $h(x)$ are the equality and inequality constraints, respectively. In the following sections we describe what constitutes these different terms as used by OPFLOW.

\subsection{Variables and bounds} \label{subsec:opflow_var}

The different variables used in \opflow formulation are described in Table \ref{tab:opflow_vars}.

\begin{table}[!htbp]
\caption{Optimal power flow (OPFLOW) variables}
\small
  \begin{tabular}{|p{0.1\textwidth}|p{0.2\textwidth}|p{0.2\textwidth}|p{0.5\textwidth}|}
   \hline
    \textbf{Symbol} & \textbf{Variable} & \textbf{Bounds} & \textbf{Notes} \\
    \hline
    $\pgj$ & Generator real power dispatch & $\pminj \le \pgj \le \pmaxj$ & ~\\
    \hline
    $\qgj$ & Generator reactive power dispatch & $\qminj \le \qgj \le \qmaxj$ & ~ \\
    \hline
    $\Deltapj$ & Generator real power deviation & $-p^{\text{r}}_j \le \Deltapj \le p^{\text{r}}_j$ & \begin{itemize}[noitemsep,topsep=0pt,leftmargin=*]  \item Only used when \option{\opflowgensetpoint} or \option{\opflowuseagc} option is active \item $\Deltapj$ is the deviation from real power generation setpoint $\psetj$.\end{itemize} \\
    \hline
    $\pgjset$ & Generator real power set-point & $\pminj \le \pgjset \le \pmaxj$ & \begin{itemize}[noitemsep,topsep=0pt,leftmargin=*] \item Only used when \option{\opflowgensetpoint} or \option{\opflowuseagc} option is active. \end{itemize} \\
    \hline
    $\Delta{P}$ & System power excess/deficit & Unbounded & Only used when \option{\opflowuseagc} is active \\
    \hline
    $\thetai$ & Bus voltage angle & -$\pi \le \thetai \le \pi$ & 
    \begin{itemize}[noitemsep,topsep=0pt,leftmargin=*] 
        \item Used with power balance polar model (\option{\opflowmodel~\pbpol}) 
        \item $\thetai$ is unbounded, except reference bus angle $\thetarefi$ which is fixed to 0 
    \end{itemize} \\
    \hline
    $\vi$ & Bus voltage magnitude & $\vmini \le \vi \le \vmaxi$ & \begin{itemize}[noitemsep,topsep=0pt,leftmargin=*] \item Used with power balance polar model (\option{\opflowmodel~\pbpol})\item $\vmini = \vmaxi = \vseti$ if fixed generator set point voltage option is active (\option{\opflowgensetpoint}) \end{itemize} \\
    \hline
  %  Bus voltage real part & $\vreali$ & $-\vmaxi \le \vreali \le \vmaxi$ & Used with power balance cartesian model (\option{\opflowmodel~ \pbcar})\\
  %  \hline
  %  Bus voltage imaginary part & $\vimagi$ & $-\vmaxi \le \vimagi \le \vmaxi$ & Used with power balance cartesian model (\option{\opflowmodel~\pbcar})\\
  %  \hline
    $\pmisplusi,\pmisminusi$ & Bus real power mismatch variables & $0 \le \pmisplusi,\pmisminusi \le \infty$ & Used when power mismatch variable option is active (\option{\opflowincludepowerimbalance}) \\
    \hline
    $\qmisplusi,\qmisminusi$ & Bus reactive power mismatch variables & $0 \le \qmisplusi,\qmisminusi \le \infty$ & Used when power mismatch variable option is active (\option{\opflowincludepowerimbalance}) \\
    \hline
    $\Deltaplj$ & Real power load loss & $0 \le \Deltaplj \le \plj $ & Used when load loss variable option is active (\option{\opflowincludeloadloss}) \\
    \hline
    $\Deltaqlj$ & Reactive power load loss & $0 \le \Deltaqlj \le \qlj$ & Used when load loss variable option is active (\option{\opflowincludeloadloss}) \\
    \hline
    $\Deltasod, \Deltasdo$ & Line flow limit violations & $0 \le \Deltasod, \Deltasdo$ & Used when line flow limit violation option is active (\option{\opflowallowlineflowviolation}) \\
    \hline
  %  Bus reactive power mismatch & $q^{mis}_i$ & Unbounded & Used when power mismatch variable option is active (\text{-opflow_include_powerimbalance_variables 1})
  %  \hline
  \end{tabular}
  \label{tab:opflow_vars}
\end{table}
Power imbalance variables are non-physical (slack) variables that measure the violation of power balance at buses. Having these variables (may) help in making the optimization problem easier to solve since they always ensure feasibility of the bus power balance constraints.

\subsection{Objective Function}\label{sec:opflow_obj}

The objective function for OPFLOW is given in (\ref{eq:opflow_obj})
\begin{equation}
\text{min.} ~ C_{gen}(p^{\text{g}}) + C_{dev}(\Delta p^{\text{g}}) +
C_{loss}(\Delta p^{\text{l}},\Delta q^{\text{l}}) + C_{imb}(\Delta p^{+},\Delta p^{-},\Delta q^{+},\Delta q^{-}) + C_{lineviol}(\Deltasod, \Deltasdo)
\label{eq:opflow_obj}
\end{equation}
 
\subsubsection{Total generation cost $C_{gen}(p^{\text{g}})$}
Needs option \opflowoption{\opflowobjective}{\mingencost}
\begin{equation}
C_{gen}(p^{\text{g}}) = \sum_{\jinJgen} \costgj(\pgj)
\label{eq:opf_obj_mingencost}
\end{equation}
Here, $\costgj$ is a quadratic function of the form $\costgj = \agj{\pgj}^2 + \bgj\pgj + \cgj$.

\subsubsection{Total generation setpoint deviation $C(\Delta p^{\text{g}})$}
Needs option \opflowoption{\opflowobjective}{\mingensetpointdeviation}
\begin{equation}
C_{dev}(\Delta p^{\text{g}}) = \sum_{\jinJgen} ({\Deltapj}^2)
\label{eq:opf_obj_mingensetpointdev}
\end{equation}
This feature is only supported with Ipopt solver.

\subsubsection{Load loss $C(\Delta p^{\text{l}},\Delta q^{\text{l}})$}
This term gets added to the objective when  \option{\opflowincludeloadloss} option is active. 
\begin{equation}
C_{loss}(\Delta p^{\text{l}},\Delta q^{\text{l}}) =  \sum_{\jinJload}{\sigmalj({\Deltaplj} + {\Deltaqlj})}
\label{eq:opf_obj_minloadloss}
\end{equation}
The load loss penalty $\sigmalj$ can be set via the option
\option{-opflow\_loadloss\_penalty}. The default is \$1000/MW for all loads.

\subsubsection{Power imbalance $C_{imb}(\Delta p^{+},\Delta p^{-},\Delta q^{+},\Delta q^{-})$}
This term gets added to the objective when  \option{-opflow\_include_powerimbalance_variables} option is active. 
\begin{equation}
C_{imb}(\Delta p^{+},\Delta p^{-},\Delta q^{+},\Delta q^{-}) =  \sum_{i \in J^{bus}}{\sigmai(\Delta p^{+} + \Delta p^{-} + \Delta q^{+} + \Delta q^{-})}
\label{eq:opf_obj_minpowerimbalance}
\end{equation}
The power imbalance cost $\sigmai$ can be set via the option
\option{-opflow\_powerimbalance\_penalty}. The default is \$10,000/MW$^2$ for all buses. Though the power imbalance variables $\Delta p^{+},\Delta p^{-},\Delta q^{+},\Delta q^{-}$ are slack or non-physical, they can help in solving infeasible cases having no power flow solution, and thus provide a measure of the infeasibility. 

\subsubsection{Line flow limit violation $C_{lineviol}(\Deltasod, \Deltasdo)$}
This term gets added to the objective when  \option{\opflowallowlineflowviolation} option is active. 
\begin{equation}
C_{lineviol}((\Deltasod, \Deltasdo)) =  \sum_{\jinJbr}{\sigmaj(\Deltasod + \Deltasdo)}
\label{eq:opf_obj_minlineviol}
\end{equation}
The line flow limit violation cost $\sigmaj$ can be set via the option
\option{\opflowlineflowviolationpenalty}. The default is \$100/MVA$^2$ for all lines.

\subsection{Equality constraints}\label{sec:opflow_eq}

\subsubsection{Nodal power balance}
The nodal power balance equations for each bus $i$ are given by
\begin{align}
\sum_{\substack{\jinJgen \\ A^{\text{g}}_{ij} \neq 0}} \pgj &=   \pshi + \pmisplusi - \pmisminusi + \sum_{\substack{\jinJload \\ A^{\text{l}}_{ij} \neq 0}} (\plj - \Deltaplj) + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{oi} \neq 0}} \pbrjod + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{id} \neq 0}} \pbrjdo \\
\sum_{\substack{\jinJgen \\ A^{\text{g}}_{ij} \neq 0}} \qgj &=  \qshi + \qmisplusi - \qmisminusi + \sum_{\substack{\jinJload \\ A^{\text{l}}_{ij} \neq 0}} (\qlj - \Deltaqlj) +
\sum_{\substack{\jinJbr \\ A^{\text{br}}_{oi} \neq 0}} \qbrjod + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{id} \neq 0}} \qbrjdo \\
\end{align}
where, the real and reactive power shunt consumption is given by (\ref{eq:opflow_sh_p}) and (\ref{eq:opflow_sh_q})


The real and reactive power flow $\pbrjod$, $\qbrjod$ for line $j$ from the origin bus $o$ to destination bus $d$ is given by (\ref{eq:opflow_br_podflow}) -- 
 (\ref{eq:opflow_br_qodflow})
and from destination bus $d$ to origin bus $o$ is given by (\ref{eq:opflow_br_pdoflow}) -- 
 (\ref{eq:opflow_br_qdoflow})

 \subsubsection{Shunt power}
\begin{align}
&\pshi = \gshi{\vi}^2 \label{eq:opflow_sh_p} \\
&\qshi = -\bshi{\vi}^2 \label{eq:opflow_sh_q}
\end{align}

\subsubsection{Generator real power output}

When using \option{\opflowgensetpoint}, two extra variables $\pgjset$ and $\Deltapj$ are added for each generator. The generator real power output $\pgj$ is related to the power deviation $\Deltapj$ by the following relations
\begin{align}
  \pgjset + \Deltapj - \pgj = 0 \\
  \pgjset - p^{\text{g*}}_j = 0
\end{align}
The second equation sets the generator set-point $\pgjset$ to a fixed value $p^{\text{g*}}_j$. Here, $p^{\text{g*}}_j$ is the set-point for the generator real power output, which can be thought of as an operator set or contractual agreement set-point.

\subsection{Inequality constraints}

\subsubsection{MVA flow on branches}
MVA flow limits at origin and destination buses for each line.
\begin{align}
  {\pbrjod}^2 + {\qbrjod}^2 \le {\srateAj}^2 + \Deltasod,~~\jinJbr\\
  {\pbrjdo}^2 + {\qbrjdo}^2 \le {\srateAj}^2 + \Deltasdo,~~\jinJbr
\end{align}
To reduce the number of inequality constraints, only lines that are in service and having MVA A rating $\srateAj$ less than 10000 MVA are considered.

\subsubsection{Branch flows}
In polar coordinates, the real and reactive power flow $\pbrjod$, $\qbrjod$  from bus $o$ to bus $d$ on line $j$ is given by (\ref{eq:opflow_br_podflow}) -- 
 (\ref{eq:opflow_br_qodflow})


\begin{align}
\pbrjod &= g_{oo}{v^2_o} + v_ov_d(g_{od}\cos(\theta_o - \theta_d) + b_{od}\sin(\theta_o - \theta_d)) \label{eq:opflow_br_podflow}\\
\qbrjod &= -b_{oo}{v^2_o} + v_ov_d(-b_{od}\cos(\theta_o - \theta_d) + g_{od}\sin(\theta_o - \theta_d)) \label{eq:opflow_br_qodflow}
\end{align}

\noindent
and from bus $d$ to bus $o$ is given by (\ref{eq:opflow_br_pdoflow}) -- (\ref{eq:opflow_br_qdoflow})

\begin{align}
\pbrjdo &= g_{dd}{v^2_d} + v_dv_o(g_{do}\cos(\theta_d - \theta_o) + b_{do}\sin(\theta_d - \theta_o))  \label{eq:opflow_br_pdoflow} \\
\qbrjdo &= -b_{dd}{v^2_d} + v_dv_o(-b_{do}\cos(\theta_d - \theta_o) + g_{do}\sin(\theta_d - \theta_o)) \label{eq:opflow_br_qdoflow}
\end{align}

\subsubsection{Automatic generation control (AGC)}
With \option{\opflowuseagc}, two additional constraints are added for each participating generator to enforce the proportional generator redispatch participation as done in automatic generation control (AGC). These two equations are 
\begin{equation}
\begin{aligned}
  \left(\alpha^{\text{g}}_j\Delta{P} - \Deltapj\right)\left(\pgj - \pmaxj\right) \ge 0 \\
  \left(\Deltapj - \alpha^{\text{g}}_j\Delta{P}\right)\left(\pminj - \pgj\right) \ge 0
\end{aligned}
\label{eq:opflow_agc}
\end{equation}
Eq. \ref{eq:opflow_agc} forces the generator set-point deviation to be equal to the generation participation when the generator has head-room available $\pminj \le \pgj \le \pmaxj$. Here, $\alpha^{\text{g}}_j$ is the generator participation factor which is the proportion of the power deficit/excess $\Delta{P}$ that the generator provides.

\subsubsection{Generator bus voltage control}
When the option \opflowoption{\opflowgenbusvoltage~\fixedwithinqbounds} is used, the generator bus voltage is fixed when the total reactive power generation available at the bus is within bounds. When it reaches its bounds, the voltage varies with the generator reactive power fixed at its bound. To implement this behavior, two inequality constraints are added for each generator bus
\begin{equation}
\begin{aligned}
(v^{\text{set}}_i - \vi)(q_i - q^{\text{max}_i}) \ge 0 \\
(\vi - v^{\text{set}}_i)(q^{\text{min}_i} - q_i) \ge 0
\end{aligned}
\label{eq:opflow_genbusvoltage}
\end{equation}
Here, $q_i$, $q^{\text{max}_i}$, and $q^{\text{min}_i}$ are the generated, maximum, and minimum reactive power at the bus, respectively.

\begin{comment}
\subssubection{Voltage magnitude for cartesian coordinates}
When using cartesian coordinates for voltages, inequality constraints (\ref{eq:opflow_ineq_vmag}) need to introduced to constraining the voltage magnitude within its bounds
\begin{equation}
  {\vmini}^2 \le {\vreali}^2 + {\vimagi}^2 \le {\vmaxi}^2,~~\iinJbus
\label{eq:opflow_ineq_vmag}
\end{equation}
\end{comment}

\section{Solvers}\label{sec:opflow_solvers}
\opflow can be used with a few different solvers. All the solvers solve the optimization problem via a nonlinear interior-point algorithm.
\begin{enumerate}
  \item \ipopt~is a popular open-source package for solving nonlinear optimization problems. It is the most robust of the solvers implemented for solving \opflow. However, it can be run only on a single process and does not have GPU support. \\ Option:
  \opflowoption{-opflow\_solver}{IPOPT} \opflowoption{-opflow_model}{POWER\_BALANCE\_POLAR}

  \item \hiop~ is a high-performance optimization library that implements an interior-point algorithm for solving nonlinear optimization problems. There are two solvers available from the \hiop library: Mixed sparse-dense formulation {\opflowoption{-opflow\_solver}{HIOP}}, and sparse formulation {\opflowoption{-opflow\_solver}{HIOPSPARSE}}. The library supports execution both on the CPU and the GPU. Options: \\ CPU: {\opflowoption{-opflow\_solver}{HIOP}} {\opflowoption{-opflow\_model}{POWER\_BALANCE\_HIOP}} {\opflowoption{-hiop\_compute\_mode}{CPU}} \\ GPU: \opflowoption{-opflow\_solver}{HIOP} {\opflowoption{-opflow\_model}{PBPOLRAJAHIOP}} {\opflowoption{-hiop\_compute\_mode}{GPU}} 

\end{enumerate}

\section{Models}\label{sec:opflow_model}

A `model' in \exago describes the representation of the underlying physics. All \opflow models use the power balance formulation in polar coordinates for the ACOPF equations. The difference between the different models arises from their specific implementation/interface. The different models available for \opflow are listed in Table \ref{tab:opflow_models}. As discussed earlier, not every `model' is compatible with every `solver'. Table \ref{tab:opflow_model_solver_compatibility} lists the solver compatibility for the different models.

\begin{table}[!h]
  \caption{OPFLOW models}
  \small
  \begin{tabular}{|p{0.2\textwidth}|p{0.4\textwidth}|p{0.2\textwidth}|p{0.15\textwidth}|}
    \hline
    \textbf{Model type} & \textbf{OPFLOW option (\opflowoption{\opflowmodel}{})} & \textbf{Compatible solvers} & \textbf{CPU-GPU}\\
    \hline
    Power balance with polar coordinates & \pbpol & IPOPT, HIOPSPARSE & CPU\\
    \hline
    Power balance with polar coordinates used with HIOP & {\pbpolhiop} & \hiop & CPU/GPU\\
    \hline
    Power balance with polar coordinates used with HIOP on GPU & {\pbpolrajahiop} & \hiop & GPU\\
    \hline
  \end{tabular}
  \label{tab:opflow_models}
\end{table}

\begin{table}[h!]
  \centering
  \caption{OPFLOW Model-solver compatibility}
  \begin{tabular}{|c|c|c|c|}
    \hline
    Model Name & \ipopt & \hiop & HIOPSPARSE \\ \hline
    POWER\_BALANCE\_POLAR & \checkmark & & \checkmark \\ \hline
%    POWER\_BALANCE\_CARTESIAN & \checkmark &  & \checkmark & \\ \hline
    POWER\_BALANCE\_HIOP & & \checkmark &  \\ \hline
    PBPOLRAJAHIOP & & \checkmark &  \\ \hline
  \end{tabular}
\label{tab:opflow_model_solver_compatibility}
\end{table}

\subsection{Power balance polar}
The power balance polar model ({\opflowmodel~\pbpol}) uses the power balance formulation with polar representation for the network voltages. It runs on CPU only and is compatible with \ipopt and sparse \hiop solvers.

\begin{comment}
\subsection{Power balance cartesian}
\end{comment}

\subsection{Power balance with HiOp on CPU}
This model ({\opflowmodel~\pbpolhiop}) implements the power balance formulation with polar coordinates used with \hiop solver only. The model evaluation is done only on the CPU, but the \hiop solver can be executed either on the CPU (\opflowoption{-hiop\_compute_mode}{CPU}) or GPU (\opflowoption{-hiop\
_compute\_mode}{HYBRID}) by setting the \option{-hiop_compute_mode} option appropriately.

\subsection{Power balance with HiOp on GPU}
The PBPOLRAJAHIOP model ({\opflowmodel~\pbpolrajahiop}) computes all the model and optimization calculations on the GPU. This model uses \raja and Umpire \cite{beckingsale2019umpire} libraries to run \opflow calculations (objective, constraints, etc.) on the GPU. 

\section{Input and Output}
The current \exago version only supports reading network files in \matpower format and can (optionally) write the output back in \matpower data file format.

\exago can optionally recognize an extension to the \matpower format with which load loss parameters can be specified for individual bus loads.  The extension adds a new array \texttt{mpc.loadcost} containing the maximum percentage loss allowed and the cost of the loss for each bus load. For example,
\begin{lstlisting}
%% load cost data
% %maxallowedloadshed %loadshedcost
mpc.loadcost = [
                 65 1000;
                 75 100;
                100 10;
];
\end{lstlisting}
Load loss information is used only if \texttt{-opflow\_include\_loadloss\_variables} is used.  If \texttt{mpc.loadcost} is not in the input, all loads are assigned a 100\% loss fraction and the same cost (\texttt{-opflow\_loadloss\_penality}).


\section{Usage}
\begin{lstlisting}
  ./opflow -netfile <netfilename>  <opflowoptions>
\end{lstlisting}

\section{Options}
See table \ref{tab:opflow_options}
\begin{table}[H]
  \caption{OPFLOW options}
  \small
  \begin{tabular}{|p{0.4\textwidth}|p{0.2\textwidth}|p{0.2\textwidth}|p{0.2\textwidth}|}
    \hline
    \textbf{Option} & \textbf{Meaning} & \textbf{Values (Default value)} & \textbf{Compatibility}\\ \hline
    -netfile & Network file name & string $<$ 4096 characters (\href{https://gitlab.pnnl.gov/exasgd/frameworks/exago/-/blob/master/datafiles/case9/case9mod.m}{case9mod.m}) & \\ \hline
    -print\_output & Print output to screen & 0 or 1 (0) & All solvers\\ \hline
    -save\_output & Save output to file & base file name (no output) & All solvers \\ \hline
    -opflow\_output\_format & Solution file format & See Table~\ref{tab:opflow_output_format} (MATPOWER) & All solvers \\ \hline
    -opflow\_model & Representation of network balance equations and bus voltages & See Table \ref{sec:opflow_model} (POWER\_BALANCE\_POLAR) & \\ \hline
    -opflow\_solver & Optimization solver & See section \ref{sec:opflow_solvers} & \\ \hline
    -opflow\_initialization & Type of initialization & See Table \ref{tab:opflow_initializations} (MIDPOINT) & All solvers \\ \hline
    -opflow\_has\_gensetpoint & Uses generation set point and activates ramping variables & 0 or 1 (0) & All models\\ \hline
    -opflow\_use\_agc & Uses AGC formulation in OPF & 0 or 1 (0) & POWER\_BALANCE \_POLAR only \\ \hline
    -opflow\_objective & type of objective function & See table \ref{tab:opflow_objtypes} (MIN\_GEN\_COST) & All models\\ \hline
    -opflow\_genbusvoltage & Type of generator bus voltage control & See Table \ref{tab:opflow_genbusvoltage} (VARIABLE\_WITHIN \_BOUNDS) & POWER\_BALANCE \_POLAR only \\ \hline
    -opflow\_ignore\_lineflow\_constraints & Ignore line flow constraints & 0 or 1 (0) & All models \\ \hline
    -opflow\_monitor\_line\_kvlevels & Monitor line flows at these KV levels & comma separated list & All models \\ \hline
    -opflow\_include\_loadloss\_variables & Include load loss & 0 or 1 (0) & All models except PBPOLRAJAHIOP \\ \hline
    -opflow\_include\_powerimbalance\_variables & Include power imbalance & 0 or 1 (0) & All models \\ \hline
    -opflow\_loadloss\_penality & \$ penalty for load loss & real (1000) & All models \\ \hline
    -opflow\_powerimbalance\_penalty & \$ penalty for power imbalance & real (10000) & All models \\ \hline
    -opflow\_tolerance & Optimization solver tolerance & real (1e-6) & All solvers \\ \hline 
  \end{tabular}
  \label{tab:opflow_options}
\end{table}

\begin{table}[H]
  \centering
  \caption{OPFLOW solution output formats}
  \label{tab:opflow_output_format}
  \begin{tabular}{|c|l|}
    \hline
    \textbf{Format name} & \textbf{Description} \\ \hline
    MATPOWER & Matlab format compatible with MATPOWER \\ \hline
    CSV & Custom comma separated variable format \\ \hline
    JSON & Javascript object notation, used for visualization \\ \hline
    MINIMAL & Simple text file containing minimal information. \\ \hline
  \end{tabular}
\end{table}

\begin{table}[!htbp]
  \centering
  \caption{OPFLOW initializations}
  \begin{tabular}{|c|c|}
    \hline
    \textbf{Initialization type} & \textbf{Meaning} \\ \hline
    MIDPOINT & Use mid-point of bounds \\ \hline
    FROMFILE & Use values from network file \\ \hline
    ACPF & Run AC power flow \\ \hline
    FLATSTART & Flat-start \\ \hline
    DCOPF & Run DC optimal power flow \\ \hline
  \end{tabular}
\label{tab:opflow_initializations}
\end{table}

\begin{table}[H]
  \centering
  \caption{OPFLOW generator bus voltage control modes}
  \begin{tabular}{|p{0.35\textwidth}|p{0.3\textwidth}|p{0.35\textwidth}|}
    \hline
    \textbf{Voltage control type} & \textbf{Meaning} & \textbf{Compatibility}\\ \hline
%    FIXED\_AT\_SETPOINT & Fixed at given set-point. Reactive power limits are ignored \\ \hline
    FIXED\_WITHIN\_QBOUNDS & Fixed within reactive power bounds & POWER\_BALANCE\_POLAR only \\ \hline
    VARIABLE\_WITHIN\_BOUNDS & Variable within voltage bounds & All models \\ \hline
  \end{tabular}
\label{tab:opflow_genbusvoltage}
\end{table}

\begin{table}[H]
  \centering
  \caption{OPFLOW objective function types}
  \begin{tabular}{|p{0.35\textwidth}|p{0.35\textwidth}|p{0.3\textwidth}|}
    \hline
    \textbf{Objective function} & \textbf{Meaning} & \textbf{Compatibility}\\ \hline
    MIN\_GEN\_COST & Minimize generation cost & All models \\ \hline
    MIN\_GENSETPOINT\_DEVIATION & Minimize deviation (ramp up-down) from generator set-point & POWER\_BALANCE\_POLAR model only\\ \hline
    NO\_OBJ & No objective function (only feasibility) & All models \\ \hline
  \end{tabular}
\label{tab:opflow_objtypes}
\end{table}


\section{Examples}

Some \opflow example runs are provided with some sample output. Options values are the default values in table \ref{tab:opflow_options} unless otherwise specified. \opflowoption{-print_output} is only used in the first example to save space. Sample output is generated by running examples from the installation directory.

Example using the \ipopt solver:

\begin{lstlisting}
./bin/opflow -opflow_solver IPOPT -opflow_model POWER_BALANCE_POLAR -netfile $EXAGO_DIR/datafiles/case9/case9mod.m -print_output
[ExaGO] Creating OPFlow


******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit http://projects.coin-or.org/Ipopt
******************************************************************************

This is Ipopt version 3.12.10, running with linear solver ma27.

Number of nonzeros in equality constraint Jacobian...:      114
Number of nonzeros in inequality constraint Jacobian.:       72
Number of nonzeros in Lagrangian Hessian.............:       96

Total number of variables............................:       24
                     variables with only lower bounds:        0
                variables with lower and upper bounds:       16
                     variables with only upper bounds:        0
Total number of equality constraints.................:       18
Total number of inequality constraints...............:       18
        inequality constraints with only lower bounds:        0
   inequality constraints with lower and upper bounds:       18
        inequality constraints with only upper bounds:        0

iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
   0  1.0318125e+04 1.80e+00 1.00e+02  -1.0 0.00e+00    -  0.00e+00 0.00e+00   0
   1  7.7157691e+03 1.17e+00 1.03e+02  -1.0 1.08e+00    -  6.27e-01 3.50e-01f  1
   2  7.6608235e+03 1.15e+00 1.01e+02  -1.0 6.28e+00    -  1.20e-02 1.37e-02f  1
   3  7.4466686e+03 1.09e+00 3.06e+02  -1.0 3.74e+00    -  4.15e-03 5.81e-02f  1
   4  5.4292675e+03 3.92e-01 4.83e+03  -1.0 7.34e-01    -  3.34e-03 6.40e-01f  1
   5  4.5792834e+03 2.24e-01 1.51e+03  -1.0 6.46e-01   2.0 8.77e-03 7.37e-01f  1
   6  4.2907579e+03 1.20e-02 3.57e+02  -1.0 3.36e-01    -  5.37e-01 1.00e+00f  1
   7  4.1690456e+03 4.40e-02 5.31e+01  -1.0 3.31e-01    -  9.22e-01 1.00e+00f  1
   8  4.1687926e+03 4.88e-04 1.93e+00  -1.0 4.79e-02   1.5 1.00e+00 1.00e+00h  1
   9  4.1497176e+03 1.19e-02 9.92e+00  -2.5 1.87e-01    -  8.38e-01 1.00e+00f  1
iter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls
  10  4.1463942e+03 1.09e-02 5.09e-01  -2.5 1.15e-01    -  8.71e-01 1.00e+00h  1
  11  4.1449657e+03 1.47e-03 1.79e-02  -2.5 2.75e-02    -  1.00e+00 1.00e+00h  1
  12  4.1445415e+03 6.63e-04 9.12e-02  -3.8 1.48e-02    -  1.00e+00 6.30e-01h  1
  13  4.1444705e+03 3.43e-04 4.96e-02  -3.8 2.08e-02    -  1.00e+00 8.93e-01h  1
  14  4.1444809e+03 4.48e-05 1.79e-04  -3.8 6.82e-03    -  1.00e+00 1.00e+00f  1
  15  4.1444611e+03 1.96e-05 4.55e-03  -5.7 4.57e-03    -  1.00e+00 9.34e-01h  1
  16  4.1444607e+03 6.49e-06 1.17e-05  -5.7 2.60e-03    -  1.00e+00 1.00e+00h  1
  17  4.1444605e+03 1.19e-06 2.07e-06  -7.0 1.11e-03    -  1.00e+00 1.00e+00h  1
  18  4.1444605e+03 1.58e-07 3.29e-07  -7.0 4.06e-04    -  1.00e+00 1.00e+00h  1

Number of Iterations....: 18

                                   (scaled)                 (unscaled)
Objective...............:   9.2925122354655841e+01    4.1444604570176507e+03
Dual infeasibility......:   3.2927387965389691e-07    1.4685615032563802e-05
Constraint violation....:   2.6639677713768961e-08    2.6639677713768961e-08
Complementarity.........:   4.7840038622596930e-07    2.1336657225678232e-05
Overall NLP error.......:   4.7840038622596930e-07    2.1336657225678232e-05


Number of objective function evaluations             = 19
Number of objective gradient evaluations             = 19
Number of equality constraint evaluations            = 19
Number of inequality constraint evaluations          = 19
Number of equality constraint Jacobian evaluations   = 19
Number of inequality constraint Jacobian evaluations = 19
Number of Lagrangian Hessian evaluations             = 18
Total CPU secs in IPOPT (w/o function evaluations)   =      0.025
Total CPU secs in NLP function evaluations           =      0.002

EXIT: Optimal Solution Found.
=============================================================
Optimal Power Flow
=============================================================
Model                               POWER_BALANCE_POLAR
Solver                              IPOPT
Objective                           MIN_GEN_COST
Initialization                      MIDPOINT
Gen. bus voltage mode               VARIABLE_WITHIN_BOUNDS
Load loss allowed                   NO
Power imbalance allowed             NO
Ignore line flow constraints        NO

Number of variables                 24
Number of equality constraints      18
Number of inequality constraints    18

Convergence status                  CONVERGED
Objective value                     4144.46

----------------------------------------------------------------------
Bus        Pd      Qd      Vm      Va      mult_Pmis      mult_Qmis      Pslack         Qslack        
----------------------------------------------------------------------
1         0.00    0.00   1.100   0.000      2102.91         0.00         0.00         0.00
2         0.00    0.00   1.095   3.928      2059.18        -0.00         0.00         0.00
3         0.00    0.00   1.087   2.120      2065.15        -0.00         0.00         0.00
4         0.00    0.00   1.097  -1.993      2103.16         0.08         0.00         0.00
5        75.00   50.00   1.079  -3.060      2113.45         7.29         0.00         0.00
6        90.00   30.00   1.087  -3.927      2129.85         1.62         0.00         0.00
7         0.00    0.00   1.100   0.535      2059.57        -0.04         0.00         0.00
8       100.00   35.00   1.089  -1.720      2079.34         2.99         0.00         0.00
9         0.00    0.00   1.100  -0.135      2065.43        -0.09         0.00         0.00

----------------------------------------------------------------------------------------
From       To       Status     Sft      Stf     Slim     mult_Sf  mult_St 
----------------------------------------------------------------------------------------
1          4          1       73.18    72.98   380.00    -0.00    -0.00
2          7          1      114.18   114.68   250.00    -0.00    -0.00
3          9          1       83.57    84.60   300.00    -0.00    -0.00
4          5          1       29.68    40.50   250.00    -0.00    -0.00
4          6          1       44.86    46.03   250.00    -0.00    -0.00
5          7          1       51.29    49.04   250.00    -0.00    -0.00
6          9          1       48.94    51.43   150.00    -0.00    -0.00
7          8          1       66.61    68.11   250.00    -0.00    -0.00
8          9          1       38.86    34.15   150.00    -0.00    -0.00

----------------------------------------------------------------------------------------
Gen      Status     Fuel     Pg       Qg       Pmin     Pmax     Qmin     Qmax  
----------------------------------------------------------------------------------------
1          1    UNDEFINED    72.86     6.79    10.00   350.00  -300.00   300.00
2          1    UNDEFINED   114.07    -5.13    10.00   300.00  -300.00   300.00
3          1    UNDEFINED    80.21   -23.47    10.00   270.00  -300.00   300.00
[ExaGO] Finalizing opflow application.
\end{lstlisting}

Example using the \hiop solver on the CPU with ACPF initialization:

\begin{lstlisting}
./bin/opflow -opflow_solver HIOP -opflow_model POWER_BALANCE_HIOP -netfile $EXAGO_DIR/datafiles/case9/case9mod.m -opflow_initialization ACPF -hiop_compute CPU -hiop_verbosity_level 3 -print_output
[ExaGO] Creating OPFlow

[Warning] Detected 1 fixed variables out of a total of 24.
===============
Hiop SOLVER
===============
Using 1 MPI ranks.
---------------
Problem Summary
---------------
Total number of variables: 24
     lower/upper/lower_and_upper bounds: 16 / 16 / 16
Total number of equality constraints: 18
Total number of inequality constraints: 18
     lower/upper/lower_and_upper bounds: 18 / 18 / 18
iter    objective     inf_pr     inf_du   lg(mu)  alpha_du   alpha_pr linesrch
   0  4.6670737e+03 3.714e-11  2.891e+03  -1.00  0.000e+00  0.000e+00  -(-)
   1  4.6431205e+03 3.373e-04  2.791e+03  -1.00  3.013e-01  3.498e-02  1(f)
   2  4.4461241e+03 6.595e-02  2.105e+03  -1.00  4.910e-01  2.467e-01  1(s)
   3  4.1942969e+03 6.464e-02  5.808e+02  -1.00  5.986e-01  8.573e-01  1(s)
   4  4.1615434e+03 8.234e-03  1.159e+02  -1.00  7.556e-01  1.000e+00  1(s)
   5  4.1471588e+03 4.414e-03  1.291e+02  -1.00  1.000e+00  1.000e+00  1(s)
   6  4.1441777e+03 2.959e-02  7.889e+01  -1.00  4.818e-01  4.030e-01  1(s)
   7  4.1448270e+03 7.926e-03  4.949e+01  -1.00  1.000e+00  1.000e+00  1(s)
   8  4.1448562e+03 1.506e-03  2.576e-01  -1.00  1.000e+00  1.000e+00  1(s)
   9  4.1444966e+03 3.576e-04  2.859e+00  -3.82  9.631e-01  6.968e-01  1(s)
iter    objective     inf_pr     inf_du   lg(mu)  alpha_du   alpha_pr linesrch
  10  4.1444617e+03 1.671e-04  2.747e+00  -3.82  9.520e-01  7.537e-01  1(s)
  11  4.1444597e+03 5.733e-05  1.190e-01  -3.82  9.716e-01  1.000e+00  1(s)
  12  4.1444610e+03 6.929e-06  5.005e-04  -3.82  1.000e+00  1.000e+00  1(s)
  13  4.1444605e+03 1.681e-06  1.400e-04  -5.73  1.000e+00  1.000e+00  1(h)
  14  4.1444605e+03 2.574e-07  2.377e-05  -5.73  1.000e+00  1.000e+00  1(h)
  15  4.1444604e+03 1.411e-08  1.319e-06  -5.73  1.000e+00  1.000e+00  1(h)
  16  4.1444604e+03 2.396e-10  2.047e-08  -7.00  1.000e+00  1.000e+00  1(h)
Successfull termination.
Total time 0.933 sec 
Hiop internal time:     total 0.932 sec     avg iter 0.058 sec 
    internal total std dev across ranks 0.000 percent
Fcn/deriv time:     total=0.001 sec  ( obj=0.000 grad=0.000 cons=0.000 Jac=0.000 Hess=0.001) 
    Fcn/deriv total std dev across ranks 0.000 percent
Fcn/deriv #: obj 18 grad 18 eq cons 18 ineq cons 18 eq Jac 18 ineq Jac 18
Total KKT time 0.931 sec 
update init 0.848sec     update linsys 0.000 sec     fact 0.071 sec 
solve rhs-manip 0.000 sec     triangular solve 0.012 sec 

=============================================================
Optimal Power Flow
=============================================================
Model                               POWER_BALANCE_HIOP
Solver                              HIOP
Objective                           MIN_GEN_COST
Initialization                      ACPF
Gen. bus voltage mode               VARIABLE_WITHIN_BOUNDS
Load loss allowed                   NO
Power imbalance allowed             NO
Ignore line flow constraints        NO

Number of variables                 24
Number of equality constraints      18
Number of inequality constraints    18

Convergence status                  CONVERGED
Objective value                     4144.46

----------------------------------------------------------------------
Bus        Pd      Qd      Vm      Va      mult_Pmis      mult_Qmis      Pslack         Qslack        
----------------------------------------------------------------------
1         0.00    0.00   1.100  -0.000      2102.91         0.00         0.00         0.00
2         0.00    0.00   1.095   3.928      2059.18        -0.00         0.00         0.00
3         0.00    0.00   1.087   2.120      2065.15        -0.00         0.00         0.00
4         0.00    0.00   1.097  -1.993      2103.17         0.07         0.00         0.00
5        75.00   50.00   1.079  -3.060      2113.46         7.29         0.00         0.00
6        90.00   30.00   1.087  -3.927      2129.85         1.62         0.00         0.00
7         0.00    0.00   1.100   0.535      2059.57        -0.04         0.00         0.00
8       100.00   35.00   1.089  -1.720      2079.34         2.99         0.00         0.00
9         0.00    0.00   1.100  -0.135      2065.43        -0.09         0.00         0.00

----------------------------------------------------------------------------------------
From       To       Status     Sft      Stf     Slim     mult_Sf  mult_St 
----------------------------------------------------------------------------------------
1          4          1       73.18    72.98   380.00    -0.00    -0.00
2          7          1      114.18   114.68   250.00    -0.00    -0.00
3          9          1       83.58    84.61   300.00    -0.00    -0.00
4          5          1       29.69    40.50   250.00    -0.00    -0.00
4          6          1       44.86    46.03   250.00    -0.00    -0.00
5          7          1       51.29    49.04   250.00    -0.00    -0.00
6          9          1       48.94    51.43   150.00    -0.00    -0.00
7          8          1       66.61    68.11   250.00    -0.00    -0.00
8          9          1       38.87    34.15   150.00    -0.00    -0.00

----------------------------------------------------------------------------------------
Gen      Status     Fuel     Pg       Qg       Pmin     Pmax     Qmin     Qmax  
----------------------------------------------------------------------------------------
1          1    UNDEFINED    72.86     6.80    10.00   350.00  -300.00   300.00
2          1    UNDEFINED   114.07    -5.13    10.00   300.00  -300.00   300.00
3          1    UNDEFINED    80.21   -23.48    10.00   270.00  -300.00   300.00
[ExaGO] Finalizing opflow application.
\end{lstlisting}

Example with HiOp solver on GPU with load loss activated. In this example, the load at bus 5 is
increased to 750 MW leading to an infeasible power flow. Activating the load loss causes shedding
of load at bus 5 and as a result makes the optimization converge.

\begin{lstlisting}
./opflow -opflow_solver HIOP -opflow_model PBPOLRAJAHIOP -netfile $EXAGO_DIR/datafiles/case9/case9mod_loadloss.m -hiop_compute_mode GPU -hiop_verbosity_level 3 -print_output -opflow_include_loadloss_variables
[ExaGO] Creating OPFlow

[Warning] Detected 1 fixed variables out of a total of 30.
===============
Hiop SOLVER
===============
Using 1 MPI ranks.
---------------
Problem Summary
---------------
Total number of variables: 30
     lower/upper/lower_and_upper bounds: 22 / 22 / 22
Total number of equality constraints: 18
Total number of inequality constraints: 18
     lower/upper/lower_and_upper bounds: 18 / 18 / 18
iter    objective     inf_pr     inf_du   lg(mu)  alpha_du   alpha_pr linesrch
   0  1.4867531e+04 7.490e+00  1.000e+05  -1.00  0.000e+00  0.000e+00  -(-)
   1  1.3403771e+04 7.490e+00  1.000e+05  -1.00  2.729e-04  1.702e-05  1(s)
   2  1.1742043e+04 7.489e+00  9.993e+04  -1.00  5.655e-03  1.102e-04  1(s)
   3  1.0453140e+04 7.484e+00  8.993e+04  -1.00  1.258e-01  6.948e-04  1(s)
   4  1.0933710e+04 7.247e+00  8.722e+04  -1.00  3.011e-02  3.073e-02  1(s)
   5  1.2262728e+04 6.691e+00  1.217e+05  -1.00  3.642e-04  7.537e-02  1(s)
   6  1.2718100e+04 6.509e+00  1.303e+05  -1.00  2.837e-04  2.663e-02  1(s)
   7  1.2721404e+04 6.508e+00  1.302e+05  -1.00  1.583e-02  1.930e-04  1(s)
   8  1.6122803e+04 5.696e+00  7.620e+04  -1.00  1.954e-03  1.492e-01  1(S)
   9  1.6366303e+04 5.692e+00  7.616e+04  -1.00  9.924e-02  8.075e-04  1(s)
iter    objective     inf_pr     inf_du   lg(mu)  alpha_du   alpha_pr linesrch
  10  1.7501119e+04 5.671e+00  7.587e+04  -1.00  3.082e-03  3.708e-03  1(s)
  11  1.7624878e+04 5.668e+00  8.682e+04  -1.00  9.630e-02  3.944e-04  1(s)
  12  2.2838548e+04 5.575e+00  8.354e+04  -1.00  1.071e-03  1.646e-02  1(s)
  ...
  ...
  47  7.4002786e+05 5.392e-03  5.252e+05  -1.00  1.365e-04  4.401e-03  1(s)
  48  7.4002761e+05 5.391e-03  5.332e+05  -1.00  2.888e-02  1.880e-03  1(s)
  49  7.4003537e+05 3.310e-03  4.892e+05  -1.00  3.124e-03  1.000e+00  1(s)
iter    objective     inf_pr     inf_du   lg(mu)  alpha_du   alpha_pr linesrch
  50  7.4002879e+05 3.234e-03  3.147e+05  -1.00  1.000e+00  2.273e-02  1(s)
  51  7.4003883e+05 1.340e-05  2.982e+03  -1.00  6.601e-01  1.000e+00  1(s)
  52  7.4003471e+05 3.828e-04  1.015e+01  -1.00  1.000e+00  1.000e+00  1(f)
  53  7.4003556e+05 2.461e-08  2.164e-01  -3.82  9.883e-01  1.000e+00  1(h)
  54  7.4003556e+05 2.665e-14  5.489e-07  -5.73  1.000e+00  1.000e+00  1(f)
Successfull termination.
Total time 1.527 sec 
Hiop internal time:     total 1.465 sec     avg iter 0.027 sec 
    internal total std dev across ranks 0.000 percent
Fcn/deriv time:     total=0.052 sec  ( obj=0.009 grad=0.003 cons=0.012 Jac=0.011 Hess=0.018) 
    Fcn/deriv total std dev across ranks 0.000 percent
Fcn/deriv #: obj 97 grad 56 eq cons 97 ineq cons 97 eq Jac 56 ineq Jac 56
Total KKT time 1.249 sec 
update init 0.773sec     update linsys 0.029 sec     fact 0.237 sec 
solve rhs-manip 0.172 sec     triangular solve 0.038 sec 

=============================================================
Optimal Power Flow
=============================================================
Model                               PBPOLRAJAHIOP
Solver                              HIOP
Objective                           MIN_GEN_COST
Initialization                      MIDPOINT
Gen. bus voltage mode               VARIABLE_WITHIN_BOUNDS
Load loss allowed                   YES
Load loss penalty ($)               1000.
Power imbalance allowed             NO
Ignore line flow constraints        NO

Number of variables                 30
Number of equality constraints      18
Number of inequality constraints    18

Convergence status                  CONVERGED
Objective value                     740035.56

----------------------------------------------------------------------
Bus        Pd      Qd      Vm      Va      mult_Pmis      mult_Qmis      Pslack         Qslack        
----------------------------------------------------------------------
1         0.00    0.00   1.100   0.000      4182.05         0.00         0.00         0.00
2         0.00    0.00   1.100  12.398      4028.36         0.00         0.00         0.00
3         0.00    0.00   1.100  16.811      6041.35         0.00         0.00         0.00
4         0.00    0.00   1.021  -4.918      5930.37     19899.38         0.00         0.00
5       417.50  109.68   0.900 -15.480    100000.00    100000.00         0.00         0.00
6        90.00   30.00   1.018  -2.414      7827.64     16824.43         0.00         0.00
7         0.00    0.00   1.052   5.271     19366.68     29169.45         0.00         0.00
8       100.00   35.00   1.053   5.150     15594.67     21709.27         0.00         0.00
9         0.00    0.00   1.083   9.964      7193.17      9437.04         0.00         0.00

----------------------------------------------------------------------------------------
From       To       Status     Sft      Stf     Slim     mult_Sf  mult_St 
----------------------------------------------------------------------------------------
1          4          1      230.52   213.89   380.00    -0.00    -0.00
2          7          1      250.00   239.12   250.00  2404.19     0.00
3          9          1      246.68   242.96   300.00     0.00     0.00
4          5          1      250.00   227.52   250.00 14113.38     0.00
4          6          1       47.20    50.98   250.00    -0.00    -0.00
5          7          1      210.17   239.03   250.00     0.00     0.00
6          9          1      137.83   144.52   150.00     0.00     0.00
7          8          1       10.10     7.53   250.00    -0.00    -0.00
8          9          1      100.92    98.82   150.00    -0.00    -0.00

----------------------------------------------------------------------------------------
Gen      Status     Fuel     Pg       Qg       Pmin     Pmax     Qmin     Qmax  
----------------------------------------------------------------------------------------
1          1    UNDEFINED   167.37   158.52    10.00   350.00  -300.00   300.00
2          1    UNDEFINED   229.90    98.21    10.00   300.00  -300.00   300.00
3          1    UNDEFINED   242.50    45.19    10.00   270.00  -300.00   300.00
[ExaGO] Finalizing opflow application.
\end{lstlisting}
