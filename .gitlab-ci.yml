.pnnl_tags_template: &pnnl_tags_definition
  tags:
    - k8s
    - ikp
    - exasgd
    - marianas

.pnnl_rules_template: &pnnl_rules_definition
  rules:
    - if: '$CI_PROJECT_ROOT_NAMESPACE == "exasgd"' # Will only apply to PNNL

.pnnl-nonhpc-tags: &pnnl-nonhpc-definition
  tags:
    - k8s
    - ikp
    - exasgd
    - basic

stages:
  - spack-create-buildcache

# Include PNNL GitLab stdlib
include:
  - remote: 'https://raw.githubusercontent.com/pnnl-miscscripts/gitlab-lib/v1/gitlab-lib.yaml'

spack-build-job:
  <<: *pnnl_rules_definition
  stage: spack-create-buildcache
    # rules:
    # - when: manual
  tags: [k8s, ikp, exasgd, basic]
  parallel:
    matrix:
      - ENVIRONMENT: [exago-develop, exago-develop-hiop-0.4.1]
  variables:
    KANIKO_EXTRA_ARGS: --single-snapshot
  extends:
  - .pnnllib-gitlab-build-container-image
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> /kaniko/s3env.sh
    - echo "export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> /kaniko/s3env.sh
    - echo "export S3_ENDPOINT_URL=http://cache.exasgd.pnl.gov" >> /kaniko/s3env.sh
    - cp "${ENVIRONMENT}.Dockerfile" Dockerfile
