.pnnl_tags_template: &pnnl_tags_definition
  tags:
    - k8s
    - ikp
    - exasgd
    - marianas

.pnnl_rules_template: &pnnl_rules_definition
  rules:
    - if: '$CI_PROJECT_ROOT_NAMESPACE == "exasgd"' # Will only apply to PNNL

.pnnl-nonhpc-tags: &pnnl-nonhpc-definition
  tags:
    - k8s
    - ikp
    - exasgd
    - basic

stages:
  - spack-create-buildcache

# Include PNNL GitLab stdlib
include:
  - remote: 'https://raw.githubusercontent.com/pnnl-miscscripts/gitlab-lib/v1/gitlab-lib.yaml'

spack-build-job:
  <<: *pnnl_rules_definition
  stage: spack-create-buildcache
    # rules:
    # - when: manual
  tags: [k8s, ikp, exasgd, basic]
  parallel:
    matrix:
      - ENVIRONMENT: [minio-test]
  variables:
      # KANIKO_EXTRA_ARGS: --single-snapshot --build-arg AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY --build-arg AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
      # extends:
      # - .pnnllib-gitlab-build-container-image
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> /kaniko/s3env.sh
    - echo "export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> /kaniko/s3env.sh
    - echo "export S3_ENDPOINT_URL=http://cache.exasgd.pnl.gov" >> /kaniko/s3env.sh
    - cp "${ENVIRONMENT}.Dockerfile" Dockerfile
  script:
  - mkdir -p /kaniko/.docker
  - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  - |
    if [ -f /etc/gitlab-runner/certs/ca.crt ]; then
      cat /etc/gitlab-runner/certs/ca.crt >> /kaniko/ssl/certs/ca-certificates.crt
    fi
  - |
    DOCKERFILE="${DOCKERFILE:-Dockerfile}"
    CONTAINER_TAG="${CONTAINER_TAG:-$CI_COMMIT_TAG}"
    KANIKO_EXTRA_ARGS="${KANIKO_EXTRA_ARGS:-}"
    /kaniko/executor --context "$CI_PROJECT_DIR" --dockerfile "$CI_PROJECT_DIR/$DOCKERFILE" --destination "$CI_REGISTRY_IMAGE${CONTAINER_PREFIX}:$CONTAINER_TAG" --build-arg AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY --build-arg AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID --single-snapshot

