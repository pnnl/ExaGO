.pnnl_tags_template: &pnnl_tags_definition
  tags:
    - k8s
    - ikp
    - exasgd
    - marianas

.pnnl_rules_template: &pnnl_rules_definition
  rules:
    - if: '$CI_PROJECT_ROOT_NAMESPACE == "exasgd"' # Will only apply to PNNL

.pnnl-nonhpc-tags: &pnnl-nonhpc-definition
  tags:
    - k8s
    - ikp
    - exasgd
    - basic

stages:
  - spack-create-buildcache

# Include PNNL GitLab stdlib
include:
  - remote: 'https://raw.githubusercontent.com/pnnl-miscscripts/gitlab-lib/v1/gitlab-lib.yaml'

spack-build-job:
  <<: *pnnl_rules_definition
  stage: spack-create-buildcache
  rules:
    - when: manual
  tags: [k8s, ikp, exasgd, basic]
  parallel:
    matrix:
      - ENVIRONMENT: [minio-test]
  variables:
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    KANIKO_EXTRA_ARGS: --single-snapshot --build-arg _AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY --build-arg _AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
  extends:
    - .pnnllib-gitlab-build-container-image
  before_script:
    - cp "${ENVIRONMENT}.Dockerfile" Dockerfile
